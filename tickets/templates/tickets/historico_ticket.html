{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Histórico do Chamado #{{ ticket.id }}</h5>
                    <a href="{% url 'tickets:detalhe_ticket' ticket.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Voltar ao Chamado
                    </a>
                </div>
                <div class="card-body">
                    {% if ticket.historico.all %}
                        <div class="timeline">
                            {% for registro in ticket.historico.all %}
                                <div class="timeline-item">
                                    <div class="timeline-marker"></div>
                                    <div class="timeline-content">
                                        <div class="timeline-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                                            <div>
                                                <span class="badge bg-{% if registro.tipo_alteracao == 'criacao' %}success
                                                                    {% elif registro.tipo_alteracao == 'edicao' %}primary
                                                                    {% elif registro.tipo_alteracao == 'atribuicao' %}info
                                                                    {% elif registro.tipo_alteracao == 'atribuicao_multipla' %}info
                                                                    {% elif registro.tipo_alteracao == 'status' %}warning
                                                                    {% elif registro.tipo_alteracao == 'prioridade' %}danger
                                                                    {% else %}secondary{% endif %}">
                                                    {{ registro.get_tipo_alteracao_display }}
                                                </span>
                                            </div>
                                            <small class="text-muted">
                                                {{ registro.data_alteracao|date:"d/m/Y H:i" }}
                                            </small>
                                        </div>
                                        <div class="timeline-body">
                                            <p class="mb-1">
                                                <strong>Usuário:</strong> {{ registro.usuario.get_full_name|default:registro.usuario.username }}
                                            </p>
                                            
                                            {% if user.is_superuser and registro.dados_anteriores %}
                                                <div class="mt-2">
                                                    <h6>Dados Anteriores:</h6>
                                                    <pre class="pre-themed p-2 rounded small overflow-auto">{{ registro.dados_anteriores|pprint }}</pre>
                                                </div>
                                            {% endif %}
                                            
                                            {% if registro.tipo_alteracao == 'atribuicao' %}
                                                <div class="mt-2">
                                                    <strong>De:</strong> {% if registro.valor_anterior %}{{ registro.valor_anterior }}{% else %}Não atribuído{% endif %}<br>
                                                    <strong>Para:</strong> {% if registro.valor_novo %}{{ registro.valor_novo }}{% else %}Não atribuído{% endif %}
                                                </div>
                                            {% elif registro.tipo_alteracao == 'atribuicao_multipla' %}
                                                <div class="mt-2">
                                                    <strong>Atribuições atualizadas:</strong><br>
                                                    {% if registro.valor_anterior %}
                                                        <div class="mb-2">
                                                            <strong>Anteriormente:</strong><br>
                                                            {{ registro.valor_anterior|linebreaks }}
                                                        </div>
                                                    {% endif %}
                                                    {% if registro.valor_novo %}
                                                        <div>
                                                            <strong>Agora:</strong><br>
                                                            {{ registro.valor_novo|linebreaks }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% elif registro.tipo_alteracao == 'status' %}
                                                <div class="mt-2">
                                                    <strong>De:</strong> {{ registro.valor_anterior }}<br>
                                                    <strong>Para:</strong> {{ registro.valor_novo }}
                                                </div>
                                            {% elif registro.tipo_alteracao == 'prioridade' %}
                                                <div class="mt-2">
                                                    <strong>De:</strong> {{ registro.valor_anterior }}<br>
                                                    <strong>Para:</strong> {{ registro.valor_novo }}
                                                </div>
                                            {% elif registro.tipo_alteracao == 'comentario' %}
                                                <div class="mt-2">
                                                    <strong>Comentário:</strong><br>
                                                    {{ registro.valor_novo|linebreaks }}
                                                </div>
                                            {% elif registro.tipo_alteracao == 'edicao' %}
                                                <div class="mt-2">
                                                    <strong>Informações atualizadas</strong><br>
                                                    {{ registro.valor_novo|linebreaks }}
                                                </div>
                                            {% elif registro.tipo_alteracao == 'campo_personalizado' %}
                                                <div class="mt-2">
                                                    {{ registro.valor_novo|linebreaks }}
                                                </div>
                                            {% else %}
                                                {% if registro.valor_novo %}
                                                    <div class="mt-2">
                                                        {{ registro.valor_novo|linebreaks }}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center">Nenhum registro de histórico encontrado.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Reset inicial para remover todas as transições/movimentos */
* {
    transition: none !important;
    transform: none !important;
}

.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline-item {
    position: relative;
    padding-left: 30px;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: 0;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--bs-primary);
}

.timeline-content {
    background-color: var(--bs-tertiary-bg);
    border: 1px solid var(--bs-border-color);
    color: var(--bs-body-color);
    border-radius: 4px;
    padding: 15px;
}

.timeline-header {
    margin-bottom: 10px;
}

.timeline-body {
    font-size: 0.9rem;
}

pre.pre-themed {
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 200px;
    background-color: var(--bs-tertiary-bg);
    color: var(--bs-body-color);
    border: 1px solid var(--bs-border-color);
}

@media (max-width: 767.98px) {
    .timeline-item {
        padding-left: 25px;
    }
    
    .timeline-marker {
        width: 10px;
        height: 10px;
    }
    
    .timeline-content {
        padding: 10px;
    }
    
    .timeline-body {
        font-size: 0.8rem;
    }
    
    pre {
        font-size: 0.7rem;
        padding: 0.5rem !important;
    }
}
</style>
{% endblock %} 